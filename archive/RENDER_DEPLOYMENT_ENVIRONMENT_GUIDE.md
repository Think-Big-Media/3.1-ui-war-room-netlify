# War Room Analytics - Render.com Environment Setup Guide

## üìã Overview

This comprehensive guide covers the complete environment configuration and secrets management setup for deploying War Room Analytics to render.com. Follow this guide to ensure a secure, production-ready deployment.

## üõ† Quick Setup Checklist

### Pre-Deployment Requirements
- [ ] Supabase project created and configured (see SUPABASE_SETUP_GUIDE.md)
- [ ] PostHog project set up for analytics (see POSTHOG_SETUP_GUIDE.md)
- [ ] Sentry project configured for error tracking (see SENTRY_SETUP_GUIDE.md)
- [ ] All environment variables validated
- [ ] Security headers implemented and tested
- [ ] Security audit passed
- [ ] Deployment tests completed

### Render.com Setup
- [ ] Render account created
- [ ] GitHub repository connected
- [ ] Environment variables configured
- [ ] Database services provisioned
- [ ] Health checks configured
- [ ] Custom domain set (optional)

---

## üîß Environment Configuration

### 1. Core Application Settings

These variables control the basic application behavior:

```bash
# Application Identity
APP_NAME="War Room Analytics"
APP_VERSION="1.0.0"
ENVIRONMENT=production          # CRITICAL: Set to 'production'
DEBUG=false                    # CRITICAL: Must be false in production
LOG_LEVEL=INFO
PORT=8000                      # Auto-set by Render

# Runtime Versions
PYTHON_VERSION=3.11.0
NODE_VERSION=18.17.0
RENDER_ENV=production
```

### 2. Security Configuration

**CRITICAL**: These must be properly configured for security:

```bash
# JWT & Encryption (Auto-generated by Render)
SECRET_KEY=[AUTO_GENERATED]     # Render generates this
JWT_SECRET=[AUTO_GENERATED]     # Render generates this
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
REFRESH_TOKEN_EXPIRE_DAYS=7
```

### 3. Database Configuration

```bash
# PostgreSQL (Auto-configured by Render database service)
DATABASE_URL=[AUTO_FROM_DATABASE]
DB_POOL_SIZE=20
DB_MAX_OVERFLOW=40
DB_POOL_RECYCLE=3600
DB_POOL_PRE_PING=true
DB_POOL_TIMEOUT=30
DB_ECHO=false

# Redis (Auto-configured by Render Redis service)
REDIS_URL=[AUTO_FROM_DATABASE]
REDIS_POOL_MIN_SIZE=10
REDIS_POOL_MAX_SIZE=20
REDIS_MAX_CONNECTIONS=50
```

### 4. CORS & Security Headers

```bash
# CORS Configuration - PRODUCTION DOMAINS ONLY
BACKEND_CORS_ORIGINS=https://war-room-oa9t.onrender.com,https://your-custom-domain.com
```

## üîó External Services Setup

### 5. Supabase Configuration (REQUIRED)

‚ö†Ô∏è **MUST BE CONFIGURED MANUALLY IN RENDER DASHBOARD**

**Setup Guide**: See `SUPABASE_SETUP_GUIDE.md` for detailed instructions.

```bash
# Backend Supabase
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Frontend Supabase (For Vite build)
VITE_SUPABASE_URL=https://your-project-id.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Legacy React App Support
REACT_APP_SUPABASE_URL=https://your-project-id.supabase.co
REACT_APP_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**Quick Setup Steps**:
1. Create Supabase project at [supabase.com](https://supabase.com)
2. Copy URL and anon key from project settings
3. Configure authentication settings and Row Level Security
4. Add environment variables to Render dashboard

### 6. PostHog Analytics Configuration (REQUIRED)

‚ö†Ô∏è **MUST BE CONFIGURED MANUALLY IN RENDER DASHBOARD**

**Setup Guide**: See `POSTHOG_SETUP_GUIDE.md` for detailed instructions.

```bash
# Backend PostHog
POSTHOG_KEY=phc_your-project-api-key-here
POSTHOG_HOST=https://app.posthog.com
POSTHOG_ENABLED=true
POSTHOG_API_KEY=phx_your-personal-api-key-here
POSTHOG_PERSON_PROFILES=identified_only

# Frontend PostHog
VITE_POSTHOG_KEY=phc_your-project-api-key-here
VITE_POSTHOG_HOST=https://app.posthog.com
```

**Quick Setup Steps**:
1. Create PostHog project at [posthog.com](https://posthog.com)
2. Copy project API key and personal API key
3. Configure data retention and privacy settings
4. Add environment variables to Render dashboard

### 7. Sentry Error Tracking Configuration (REQUIRED)

‚ö†Ô∏è **MUST BE CONFIGURED MANUALLY IN RENDER DASHBOARD**

**Setup Guide**: See `SENTRY_SETUP_GUIDE.md` for detailed instructions.

```bash
# Sentry Configuration
SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=0.1    # 10% of transactions for cost control
SENTRY_PROFILES_SAMPLE_RATE=0.1  # 10% for profiling

# Frontend Sentry (if separate project)
VITE_SENTRY_DSN=https://your-frontend-dsn@sentry.io/project-id
VITE_SENTRY_ENVIRONMENT=production
```

**Quick Setup Steps**:
1. Create Sentry projects at [sentry.io](https://sentry.io)
2. Create separate projects for frontend and backend
3. Copy DSN values from project settings
4. Configure alert rules and team notifications
5. Add environment variables to Render dashboard

### 8. Security Hardening Configuration

**Security headers are automatically applied via middleware in serve_bulletproof.py**

```bash
# Security Headers (Implemented in Code)
# - Content-Security-Policy: XSS protection
# - X-Frame-Options: DENY (clickjacking protection)  
# - X-Content-Type-Options: nosniff
# - Strict-Transport-Security: Force HTTPS
# - Referrer-Policy: strict-origin-when-cross-origin
# - Permissions-Policy: Limit browser permissions

# CORS Security Configuration
BACKEND_CORS_ORIGINS=https://war-room-oa9t.onrender.com,https://your-custom-domain.com
CORS_ALLOW_CREDENTIALS=true
CORS_MAX_AGE=86400
```

### 9. API Configuration

```bash
# API URLs (Production)
API_BASE_URL=https://war-room-oa9t.onrender.com
VITE_API_URL=https://war-room-oa9t.onrender.com
VITE_API_BASE_URL=https://war-room-oa9t.onrender.com
```

### 7. Analytics & Monitoring (REQUIRED)

‚ö†Ô∏è **MUST BE CONFIGURED MANUALLY IN RENDER DASHBOARD**

```bash
# PostHog Analytics
POSTHOG_KEY=phc_your_api_key_here
POSTHOG_HOST=https://app.posthog.com
POSTHOG_ENABLED=true
POSTHOG_API_KEY=your_project_api_key
POSTHOG_PERSON_PROFILES=identified_only
VITE_POSTHOG_KEY=phc_your_api_key_here
VITE_POSTHOG_HOST=https://app.posthog.com

# Sentry Error Tracking
SENTRY_DSN=https://your-key@your-org.ingest.sentry.io/project-id
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=0.1
SENTRY_PROFILES_SAMPLE_RATE=0.1
```

### 8. Feature Flags

```bash
# Backend Feature Flags
ENABLE_ANALYTICS=true
ENABLE_AUTOMATION=true
ENABLE_DOCUMENT_INTELLIGENCE=false    # Enable when AI services configured
ENABLE_REAL_TIME_UPDATES=true
ENABLE_EXPORT_FEATURE=true
ENABLE_ADVANCED_ANALYTICS=true

# Frontend Feature Flags
VITE_ENV=production
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_AUTOMATION=true
VITE_ENABLE_DOCUMENT_INTELLIGENCE=false
VITE_ENABLE_GOOGLE_AUTH=false
VITE_ENABLE_GITHUB_AUTH=false
VITE_FORCE_MOCK_MODE=false

# Legacy React App Flags
REACT_APP_ENV=production
REACT_APP_ENABLE_ANALYTICS=true
REACT_APP_ENABLE_AUTOMATION=true
REACT_APP_ENABLE_DOCUMENT_INTELLIGENCE=false
REACT_APP_ENABLE_GOOGLE_AUTH=false
REACT_APP_ENABLE_GITHUB_AUTH=false
REACT_APP_DEFAULT_ORG_ID=""
```

### 9. Optional External Services

Configure these when ready to enable additional features:

```bash
# Meta/Facebook Marketing API (Optional)
VITE_META_APP_ID=your_meta_app_id
VITE_META_APP_SECRET=your_meta_app_secret
VITE_META_ACCESS_TOKEN=your_access_token
META_APP_ID=your_meta_app_id
META_APP_SECRET=your_meta_app_secret

# Google Ads API (Optional)
GOOGLE_ADS_DEVELOPER_TOKEN=your_developer_token
GOOGLE_ADS_CLIENT_ID=your_client_id.googleusercontent.com
GOOGLE_ADS_CLIENT_SECRET=your_client_secret
VITE_GOOGLE_ADS_CLIENT_ID=your_client_id.googleusercontent.com

# AI Services (Optional)
OPENAI_API_KEY=sk-your_openai_key
VITE_OPENAI_API_KEY=sk-your_openai_key
PINECONE_API_KEY=your_pinecone_key
VITE_PINECONE_API_KEY=your_pinecone_key

# Communication Services (Optional)
SENDGRID_API_KEY=SG.your_sendgrid_key
TWILIO_ACCOUNT_SID=ACyour_twilio_sid
TWILIO_AUTH_TOKEN=your_twilio_token
NOTIFICATION_EMAIL=notifications@your-domain.com
```

---

## üöÄ Render.com Deployment Steps

### Step 1: Repository Setup

1. **Connect GitHub Repository**
   ```bash
   # Ensure your repository is pushed to GitHub
   git remote add origin https://github.com/your-username/war-room.git
   git branch -M main
   git push -u origin main
   ```

2. **Verify render.yaml**
   - Ensure `render.yaml` is in the repository root
   - Validate the configuration using our test script

### Step 2: Create Render Services

1. **Log into Render.com**
   - Go to https://render.com
   - Sign up/login with GitHub

2. **Create Web Service**
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository
   - Select branch: `main`
   - Render will auto-detect `render.yaml`

3. **Create Databases**
   ```yaml
   # These will be automatically created from render.yaml
   PostgreSQL: war-room-db (256MB, Oregon)
   Redis: war-room-redis (25MB, Oregon)
   ```

### Step 3: Configure Environment Variables

‚ö†Ô∏è **CRITICAL**: Configure these manually in the Render dashboard:

#### Required Immediately:
1. **Supabase Configuration**
   ```
   VITE_SUPABASE_URL = https://your-project.supabase.co
   VITE_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIs...
   REACT_APP_SUPABASE_URL = https://your-project.supabase.co
   REACT_APP_SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIs...
   ```

2. **PostHog Analytics**
   ```
   POSTHOG_KEY = phc_your_api_key
   POSTHOG_API_KEY = your_project_api_key
   VITE_POSTHOG_KEY = phc_your_api_key
   ```

3. **Sentry Error Tracking**
   ```
   SENTRY_DSN = https://key@org.ingest.sentry.io/project
   ```

#### How to Add Environment Variables:
1. Go to your service dashboard
2. Click "Environment" tab
3. Add each variable:
   - Key: Variable name
   - Value: Your actual value
   - Check "Secret" for sensitive values

### Step 4: Deploy

1. **Trigger Deployment**
   - Render will automatically deploy when you push to main
   - Or click "Manual Deploy" in dashboard

2. **Monitor Build Process**
   - Watch build logs for errors
   - Build should complete in 5-10 minutes

3. **Verify Health Check**
   - Render will check `/health` endpoint
   - Service should show "Live" status

---

## üîí Security Configuration

### Essential Security Settings

1. **Environment-Specific Configurations**
   ```bash
   # NEVER in production:
   DEBUG=false                    # Must be false
   # No localhost URLs
   # No wildcard CORS origins
   # No test/dev secrets
   ```

2. **SSL/TLS Configuration**
   - Render provides automatic SSL certificates
   - All traffic is HTTPS by default
   - No additional configuration needed

3. **Secret Management**
   - Use Render's environment variable system
   - Mark sensitive variables as "Secret"
   - Never commit secrets to code
   - Rotate secrets regularly

### Security Validation

Run our security audit script:

```bash
# Security audit
python scripts/security-audit-env.py --ci --severity high

# Environment validation
python src/backend/core/env_validation.py --env production

# Deployment configuration test
python scripts/test-deployment-config.py --env production --ci
```

---

## üß™ Testing & Validation

### Pre-Deployment Validation

1. **Environment Variable Validation**
   ```bash
   # Validate all environment variables
   python src/backend/core/env_validation.py --env production
   
   # Generate .env template
   python src/backend/core/env_validation.py --env production --generate-template --output .env.production.template
   ```

2. **Security Audit**
   ```bash
   # Run security audit
   python scripts/security-audit-env.py --path . --ci --severity high
   
   # Generate security report
   python scripts/security-audit-env.py --json security-audit-report.json
   ```

3. **Configuration Testing**
   ```bash
   # Test deployment configuration
   python scripts/test-deployment-config.py --env production --ci --timeout 120
   
   # Save test report
   python scripts/test-deployment-config.py --env production --json deployment-test-report.json
   ```

### Post-Deployment Verification

1. **Health Check**
   ```bash
   curl https://your-app.onrender.com/health
   # Should return: {"status": "healthy", "timestamp": "..."}
   ```

2. **API Endpoints**
   ```bash
   # Test API accessibility
   curl https://your-app.onrender.com/api/v1/health
   
   # Test frontend serving
   curl -I https://your-app.onrender.com
   ```

3. **External Service Connectivity**
   - Check Supabase connection
   - Verify PostHog events
   - Test Sentry error reporting

---

## üìä Monitoring & Maintenance

### Application Monitoring

1. **Render Dashboard**
   - Monitor service health
   - View deployment logs
   - Track resource usage
   - Set up alerts

2. **PostHog Analytics**
   - User behavior tracking
   - Feature usage analytics
   - Performance monitoring
   - A/B testing

3. **Sentry Error Tracking**
   - Real-time error monitoring
   - Performance monitoring
   - Release tracking
   - Alert configuration

### Performance Optimization

1. **Database Performance**
   ```bash
   # Connection pool settings (already configured)
   DB_POOL_SIZE=20
   DB_MAX_OVERFLOW=40
   DB_POOL_RECYCLE=3600
   ```

2. **Caching Strategy**
   ```bash
   # Redis cache TTL settings
   ANALYTICS_CACHE_TTL=300      # 5 minutes
   USER_ACTIVITY_CACHE_TTL=1800 # 30 minutes
   ```

3. **Rate Limiting**
   ```bash
   RATE_LIMIT_ANALYTICS=30/minute
   RATE_LIMIT_EXPORT=10/hour
   RATE_LIMIT_WEBSOCKET=100/minute
   ```

### Backup & Recovery

1. **Database Backups**
   - Render provides automatic daily backups
   - Retention: 7 days (starter plan)
   - Manual backup option available

2. **Configuration Backup**
   - Keep environment variables documented
   - Store render.yaml in version control
   - Maintain deployment documentation

---

## üêõ Troubleshooting

### Common Deployment Issues

1. **Build Failures**
   ```bash
   # Check Node.js memory limits
   export NODE_OPTIONS="--max-old-space-size=1024"
   
   # Verify Python version
   python --version  # Should be 3.11.0
   
   # Check npm dependencies
   npm install --legacy-peer-deps
   ```

2. **Environment Variable Issues**
   ```bash
   # Validate environment variables
   python src/backend/core/env_validation.py --env production
   
   # Check for missing variables
   env | grep -E "(VITE_|REACT_APP_|SUPABASE|POSTHOG)"
   ```

3. **Database Connection Issues**
   ```bash
   # Verify DATABASE_URL format
   echo $DATABASE_URL
   # Should be: postgresql://user:pass@host:port/dbname
   
   # Test Redis connection
   redis-cli -u $REDIS_URL ping
   ```

4. **Health Check Failures**
   ```bash
   # Check if health endpoint is accessible
   curl -v https://your-app.onrender.com/health
   
   # Verify application startup
   # Check Render logs for startup errors
   ```

### Debug Commands

```bash
# Environment debugging
python -c "import os; print({k:v for k,v in os.environ.items() if any(x in k for x in ['VITE_', 'REACT_APP_', 'SUPABASE', 'DATABASE'])})"

# Network debugging
nslookup your-app.onrender.com
curl -I https://your-app.onrender.com

# Application debugging (check logs in Render dashboard)
# Look for: Python startup errors, database connection issues, missing environment variables
```

---

## üìö External Service Setup

### Supabase Configuration

1. **Create Supabase Project**
   - Go to https://supabase.com
   - Create new project
   - Choose region closest to Oregon (US-West)

2. **Configure Authentication**
   ```sql
   -- Enable Row Level Security
   ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
   
   -- Create policies for user data access
   CREATE POLICY "Users can view own profile" ON profiles
   FOR SELECT USING (auth.uid() = id);
   ```

3. **Get API Keys**
   - Go to Project Settings ‚Üí API
   - Copy "Project URL" ‚Üí `SUPABASE_URL`
   - Copy "anon public" key ‚Üí `SUPABASE_ANON_KEY`
   - Copy "service_role secret" ‚Üí `SUPABASE_SERVICE_ROLE_KEY`

### PostHog Setup

1. **Create PostHog Account**
   - Go to https://posthog.com
   - Create account and project

2. **Get API Keys**
   - Go to Project Settings
   - Copy "Project API Key" ‚Üí `POSTHOG_KEY`
   - Copy "Project API Key" ‚Üí `POSTHOG_API_KEY`

3. **Configure Events**
   ```javascript
   // PostHog will automatically track:
   // - Page views
   // - Button clicks
   // - Form submissions
   // - Custom events from the application
   ```

### Sentry Setup

1. **Create Sentry Project**
   - Go to https://sentry.io
   - Create account and JavaScript project

2. **Get DSN**
   - Go to Project Settings ‚Üí Client Keys
   - Copy DSN ‚Üí `SENTRY_DSN`

3. **Configure Alerts**
   - Set up error alerts
   - Configure performance monitoring
   - Set up release tracking

---

## üîÑ CI/CD Integration

### Automated Deployment

```yaml
# .github/workflows/deploy.yml (optional)
name: Deploy to Render
on:
  push:
    branches: [main]
jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate Environment
        run: |
          python src/backend/core/env_validation.py --env production
      - name: Security Audit
        run: |
          python scripts/security-audit-env.py --ci --severity high
      - name: Test Configuration
        run: |
          python scripts/test-deployment-config.py --env production --ci
      # Render auto-deploys from GitHub, no additional steps needed
```

### Quality Gates

```bash
# Run all validation checks
./scripts/validate-render-deployment.sh

# Contents of validate-render-deployment.sh:
#!/bin/bash
set -e

echo "üîç Running environment validation..."
python src/backend/core/env_validation.py --env production

echo "üîí Running security audit..."
python scripts/security-audit-env.py --ci --severity high

echo "üß™ Running configuration tests..."
python scripts/test-deployment-config.py --env production --ci

echo "‚úÖ All validation checks passed!"
```

---

## üéØ Success Metrics

### Deployment Success Indicators

1. **Green Health Checks**
   - `/health` endpoint returns 200
   - All services show "Live" in Render

2. **Zero Critical Security Issues**
   - Security audit passes
   - No hardcoded secrets
   - HTTPS everywhere

3. **All Tests Pass**
   - Environment validation: PASS
   - Configuration tests: PASS
   - External service connectivity: PASS

4. **Monitoring Active**
   - PostHog receiving events
   - Sentry monitoring errors
   - Application logs flowing

### Performance Targets

- **Response Time**: < 2 seconds
- **Uptime**: > 99.9%
- **Error Rate**: < 0.1%
- **Build Time**: < 10 minutes

---

## üìû Support & Resources

### Documentation
- [Render.com Documentation](https://render.com/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [PostHog Documentation](https://posthog.com/docs)

### Tools Created
- `src/backend/core/env_validation.py` - Environment validation
- `scripts/security-audit-env.py` - Security audit
- `scripts/test-deployment-config.py` - Configuration testing
- `.env.template` - Environment template
- `render.yaml` - Deployment configuration

### Getting Help

1. **Check Logs**
   - Render dashboard ‚Üí Logs tab
   - Look for startup errors

2. **Run Diagnostics**
   ```bash
   # Environment diagnostics
   python src/backend/core/env_validation.py --env production
   
   # Security check
   python scripts/security-audit-env.py
   
   # Configuration test
   python scripts/test-deployment-config.py --env production
   ```

3. **Common Solutions**
   - Restart the service in Render dashboard
   - Re-deploy with manual trigger
   - Check environment variable spelling
   - Verify external service connectivity

---

## ‚úÖ Final Deployment Checklist

Before going live, ensure all items are complete:

### Pre-Deployment
- [ ] Supabase project created and configured
- [ ] PostHog project set up
- [ ] Sentry project configured
- [ ] All environment variables documented
- [ ] Security audit passes (`python scripts/security-audit-env.py --ci`)
- [ ] Environment validation passes (`python src/backend/core/env_validation.py --env production`)
- [ ] Configuration tests pass (`python scripts/test-deployment-config.py --env production --ci`)

### During Deployment
- [ ] GitHub repository connected to Render
- [ ] Environment variables configured in Render dashboard
- [ ] Database services provisioned
- [ ] Build completes successfully
- [ ] Health checks pass
- [ ] Application shows "Live" status

### Post-Deployment
- [ ] Health endpoint accessible (`curl https://your-app.onrender.com/health`)
- [ ] Frontend loads correctly
- [ ] API endpoints respond
- [ ] Database connectivity verified
- [ ] PostHog receiving events
- [ ] Sentry monitoring active
- [ ] Performance within targets
- [ ] Custom domain configured (if applicable)
- [ ] SSL certificate active

### Ongoing Maintenance
- [ ] Monitor application health daily
- [ ] Review error logs weekly
- [ ] Update dependencies monthly
- [ ] Rotate secrets quarterly
- [ ] Review and update documentation as needed

---

**üéâ Congratulations!** Your War Room Analytics platform should now be successfully deployed to render.com with a complete, secure, and production-ready environment configuration.